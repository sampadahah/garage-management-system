{% extends "customer_base.html" %}
{% load static %}

{% block page_title %}Edit Part{% endblock %}
{% block page_subtitle %}Update part details{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'adminpanel.css' %}">
{% endblock %}

{% block content %}
<div class="ap-page-center">
  <div class="ap-card-large">

    <!-- Header -->
    <div class="ap-header">
      <h2 class="ap-title-large">Edit Part</h2>
      <a href="{% url 'adminpanel:inventory' %}" class="ap-btn ap-btn-outline">← Back to Inventory</a>
    </div>

    <form method="post" id="editItemForm" onsubmit="return validateForm('editItemForm')">
      {% csrf_token %}

      {% if form.errors %}
      <div class="ap-alert ap-alert-warning">
        <div class="ap-alert-icon">!</div>
        <div class="ap-alert-content">
          <h4 class="ap-alert-title">Please correct the errors below</h4>
        </div>
      </div>
      {% endif %}

      <!-- Part Name -->
      <div class="ap-form-group">
        <label class="ap-label" for="id_name">Part Name <span class="ap-required">*</span></label>
        {{ form.name }}
        {% if form.name.errors %}
          <div class="ap-error">{{ form.name.errors }}</div>
        {% endif %}
      </div>

      <!-- Compatible Model -->
      <div class="ap-form-group">
        <label class="ap-label" for="id_compatible_model">Compatible Model</label>
        {{ form.compatible_model }}
      </div>

      <!-- Price + Quantity -->
      <div class="ap-grid ap-grid-2">
        <div class="ap-form-group">
          <label class="ap-label" for="id_price">Price ($) <span class="ap-required">*</span></label>
          {{ form.price }}
          {% if form.price.errors %}
            <div class="ap-error">{{ form.price.errors }}</div>
          {% endif %}
        </div>

        <div class="ap-form-group">
          <label class="ap-label" for="id_quantity">Quantity <span class="ap-required">*</span></label>
          {{ form.quantity }}
          {% if form.quantity.errors %}
            <div class="ap-error">{{ form.quantity.errors }}</div>
          {% endif %}
        </div>
      </div>

      <!-- Min Stock + Category -->
      <div class="ap-grid ap-grid-2">
        <div class="ap-form-group">
          <label class="ap-label" for="id_min_stock_level">Minimum Stock Level</label>
          {{ form.min_stock_level }}
          <small class="ap-help">Alert when stock falls below this level</small>
        </div>

        <div class="ap-form-group">
          <label class="ap-label" for="id_category">Category</label>
          {{ form.category }}
        </div>
      </div>

      <!-- Brand -->
      <div class="ap-grid ap-grid-2">
        <div class="ap-form-group">
          <label class="ap-label" for="id_brand">Brand</label>
          {{ form.brand }}
        </div>
      </div>

      <!-- Actions -->
      <div class="ap-actions ap-actions-3">
        <button type="submit" class="ap-btn ap-btn-primary">Update Part</button>

        <a href="{% url 'adminpanel:inventory' %}" class="ap-btn ap-btn-outline">Cancel</a>

        <a href="{% url 'adminpanel:delete_inventory_item' item.part_id %}"
           class="ap-btn ap-btn-danger"
           onclick="return confirm('Are you sure you want to delete this part?')">
          Delete
        </a>
      </div>
    </form>

    <!-- Stock Status Info -->
    <div class="ap-info-card">
      <h4 class="ap-section-title">Stock Status Information</h4>

      <div class="ap-legend-grid">
        <div class="ap-legend-item">
          <span class="ap-legend-box ap-legend-success"></span>
          <span>In Stock: Quantity &gt; {{ item.min_stock_level }}</span>
        </div>

        <div class="ap-legend-item">
          <span class="ap-legend-box ap-legend-warning"></span>
          <span>Low Stock: 1 ≤ Quantity ≤ {{ item.min_stock_level }}</span>
        </div>

        <div class="ap-legend-item">
          <span class="ap-legend-box ap-legend-danger"></span>
          <span>Out of Stock: Quantity = 0</span>
        </div>
      </div>

      <div class="ap-info-meta">
        <p>
          <strong>Current Status:</strong>
          <span class="ap-badge ap-badge-{{ item.stock_status_color }}">{{ item.stock_status_display }}</span>
        </p>
        <p><strong>Last Updated:</strong> {{ item.updated_at|date:"F d, Y H:i" }}</p>
        <p><strong>Created:</strong> {{ item.created_at|date:"F d, Y" }}</p>
      </div>
    </div>

  </div>
</div>

<script>
  // Apply custom input styles to Django-rendered fields
  document.querySelectorAll('#editItemForm input, #editItemForm select, #editItemForm textarea').forEach(field => {
    if (field.type === "hidden") return;
    field.classList.add('ap-input');
    if (field.tagName.toLowerCase() === 'textarea') field.classList.add('ap-textarea');
  });

  // Simple validation highlight (required only)
  function validateForm(formId) {
    const form = document.getElementById(formId);
    const requiredFields = form.querySelectorAll('[required]');
    let ok = true;

    requiredFields.forEach(field => {
      if (!field.value || !field.value.trim()) {
        field.classList.add('ap-input-error');
        ok = false;
      } else {
        field.classList.remove('ap-input-error');
      }
    });

    return ok;
  }
</script>
{% endblock %}